{% extends "base.html" %}
{% block title %}Trang chá»§ quáº£n trá»‹ Smart Parking{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_home.css') }}?v=2">
{% endblock %}

{% block content %}
<div class="page-wrap">

  <!-- TiÃªu Ä‘á» (giá»¯ nhÆ°ng gá»n) -->
  <div class="page-title">
    <div class="icon">ğŸ¢</div>
    <h2 class="text">Trang chá»§ quáº£n trá»‹ Smart Parking</h2>
  </div>

  <div class="row g-3 mb-4">
    <!-- 1. Tá»”NG Sá» CÆ¯ DÃ‚N -->
    <div class="col-md-4">
      <a href="{{ url_for('admin_residents_list') }}" class="stat-card-link">
        <div class="card stat-card h-100">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="stat-label">Tá»•ng sá»‘ cÆ° dÃ¢n</div>
              <div class="stat-value text-primary">{{ stats.total_residents }}</div>
            </div>
            <div class="stat-icon text-primary">ğŸ‘¥</div>
          </div>
        </div>
      </a>
    </div>

    <!-- 2. KHÃCH NGOÃ€I HÃ”M NAY -->
    <div class="col-md-4">
      <a href="{{ url_for('admin_guests') }}" class="stat-card-link">
        <div class="card stat-card h-100">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="stat-label">KhÃ¡ch ngoÃ i hÃ´m nay</div>
              <div class="stat-value text-success">{{ stats.total_guests_today }}</div>
            </div>
            <div class="stat-icon text-success">ğŸš—</div>
          </div>
        </div>
      </a>
    </div>

    <!-- 3. XE ÄANG á» BÃƒI -->
    <div class="col-md-4">
      <a href="{{ url_for('admin_active_vehicles') }}" class="stat-card-link">
        <div class="card stat-card h-100">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="stat-label">Xe Ä‘ang á»Ÿ bÃ£i</div>
              <div class="stat-value text-warning">{{ stats.active_vehicles }}</div>
            </div>
            <div class="stat-icon text-warning">ğŸ…¿ï¸</div>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- =========================
        TRáº M Cá»”NG (STATUS + UNLOCK)
      ========================= -->
  <div class="card mb-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="fw-semibold">ğŸš§ Tráº¡m cá»•ng</div>

      <div class="gate-actions">
        <!-- âœ… Má» TAB Má»šI: khÃ´ng truyá»n ngÆ°á»£c -->
        <a class="btn btn-sm btn-outline-primary"
           href="/gate/plate"
           target="_blank"
           rel="noopener">
          ğŸ§¾ Má»Ÿ Tráº¡m cá»•ng
        </a>

        <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()">LÃ m má»›i</button>

        {% if gate_locked %}
          <button id="btnUnlockGate" class="btn btn-sm btn-danger">
            ğŸ”“ Má»Ÿ khÃ³a
          </button>
        {% else %}
          <span class="badge bg-success">Äang hoáº¡t Ä‘á»™ng</span>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      {% if gate_locked %}
        <div class="alert alert-danger mb-0">
          <div class="fw-bold">TRáº M ÄANG Bá»Š KHÃ“A</div>
          {% if gate_lock_info and gate_lock_info.locked_reason %}
            <div class="mt-1">{{ gate_lock_info.locked_reason }}</div>
          {% endif %}
          {% if gate_lock_info and gate_lock_info.locked_at %}
            <div class="text-muted mt-1">KhÃ³a lÃºc: {{ gate_lock_info.locked_at }}</div>
          {% endif %}
          <div class="mt-2">
            Nháº¥n <b>Má»Ÿ khÃ³a</b> Ä‘á»ƒ cho tráº¡m hoáº¡t Ä‘á»™ng láº¡i ngay.
          </div>
        </div>
      {% else %}
        <div class="alert alert-success mb-0">
          <span class="me-2">ğŸŸ¢</span><b>TRáº M ÄANG HOáº T Äá»˜NG BÃŒNH THÆ¯á»œNG</b>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">
    <!-- Doanh thu 7 ngÃ y -->
    <div class="col-lg-6">
      <div class="card chart-card">
        <div class="card-header">
          <div class="chart-title">ğŸ“Š Doanh thu 7 ngÃ y gáº§n nháº¥t</div>
        </div>
        <div class="card-body">
          <div class="chart-box">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- LÆ°á»£t xe ra/vÃ o 7 ngÃ y -->
    <div class="col-lg-6">
      <div class="card chart-card">
        <div class="card-header">
          <div class="chart-title">ğŸš— LÆ°á»£t xe ra/vÃ o 7 ngÃ y gáº§n nháº¥t</div>
        </div>
        <div class="card-body">
          <div class="chart-box">
            <canvas id="trafficChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if notifications and notifications|length > 0 %}
    <div class="mt-3">
      {% for n in notifications %}
        <div class="alert alert-{{ n.level }} mb-2">
          {{ n.message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const revenueLabels = {{ revenue_labels|tojson }};
const revenueValues = {{ revenue_values|tojson }};
const trafficLabels = {{ traffic_labels|tojson }};
const trafficIn = {{ traffic_in|tojson }};
const trafficOut = {{ traffic_out|tojson }};

new Chart(document.getElementById('revenueChart'), {
  type: 'line',
  data: {
    labels: revenueLabels,
    datasets: [{
      label: 'Doanh thu (VNÄ)',
      data: revenueValues,
      tension: 0.35,
      fill: false,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: true } },
    scales: { y: { beginAtZero: true } }
  }
});

new Chart(document.getElementById('trafficChart'), {
  type: 'line',
  data: {
    labels: trafficLabels,
    datasets: [{
      label: 'Xe vÃ o',
      data: trafficIn,
      tension: 0.35,
      fill: false,
    },{
      label: 'Xe ra',
      data: trafficOut,
      tension: 0.35,
      fill: false,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: true } },
    scales: { y: { beginAtZero: true } }
  }
});

// ========= UNLOCK BUTTON =========
const btnUnlock = document.getElementById("btnUnlockGate");
if (btnUnlock){
  btnUnlock.addEventListener("click", async () => {
    btnUnlock.disabled = true;
    btnUnlock.innerText = "Äang má»Ÿ khÃ³a...";

    try{
      const resp = await fetch("/admin/gate/unlock", { method: "POST" });
      const data = await resp.json();
      if (data && data.ok){
        location.reload();
        return;
      }
      alert((data && data.message) || "Má»Ÿ khÃ³a tháº¥t báº¡i.");
    }catch(e){
      alert("KhÃ´ng gá»i Ä‘Æ°á»£c server. Kiá»ƒm tra backend Ä‘ang cháº¡y.");
    }finally{
      btnUnlock.disabled = false;
      btnUnlock.innerText = "ğŸ”“ Má»Ÿ khÃ³a";
    }
  });
}
</script>
{% endblock %}
