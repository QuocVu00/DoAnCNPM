{% extends "base.html" %}
{% block title %}Trạm cổng – Quét biển số{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .gate-wrap{max-width:1100px;margin:0 auto}
    .gate-hero{
      background: linear-gradient(135deg,#2563eb,#10b981);
      color:#fff;border-radius:16px;padding:18px 20px;
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .gate-hero h3{margin:0;font-weight:800}
    .gate-hero p{margin:0;opacity:.95}
    .gate-card video{width:100%;max-height:420px;border-radius:14px;background:#000;object-fit:cover}
    .big-status{
      border-radius:14px;padding:16px 18px;font-size:20px;font-weight:800;
      display:none;
    }
    .big-status.show{display:block}
    .lock-box{
      border:2px dashed #dc3545;border-radius:14px;padding:14px 16px;background:#fff5f5
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4 gate-wrap">
  <div class="gate-hero mb-3">
    <div>
      <h3>TRẠM CỔNG – QUÉT BIỂN SỐ</h3>
      <p>Camera tự động bật và tự nhận diện liên tục</p>
    </div>
    <div class="text-end">
      <div class="badge bg-dark">Gate</div>
    </div>
  </div>

  {% if gate_locked %}
  <div class="lock-box mb-3">
    <div class="fw-bold text-danger">⚠ Trạm đang bị khóa</div>
    <div>Do khách nhập sai mã vé quá 3 lần. Chỉ Admin mới mở khóa được.</div>

    {% if session.get("role") == "admin" %}
    <button id="btn-unlock" class="btn btn-danger mt-2">Mở khóa trạm</button>
    <div id="unlock-msg" class="mt-2 text-success fw-bold" style="display:none;">Đã mở khóa! Reload trang để chạy lại.</div>
    {% endif %}
  </div>
  {% endif %}

  <div id="status" class="big-status alert alert-info"></div>

  <div class="card shadow-sm">
    <div class="card-body">
      <video id="cam" autoplay playsinline></video>
      <canvas id="cv" style="display:none;"></canvas>
    </div>
  </div>
</div>

<script>
  const video = document.getElementById("cam");
  const canvas = document.getElementById("cv");
  const statusBox = document.getElementById("status");

  let stream = null;
  let busy = false;
  let stopped = false;

  function showStatus(msg, cls="alert alert-info"){
    statusBox.className = "big-status show " + cls;
    statusBox.innerText = msg;
  }

  async function startCamera(){
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
  }

  function snapDataURL(){
    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);
    return canvas.toDataURL("image/png");
  }

  async function loopCapture(){
    if (stopped) return;
    if (busy) return;

    busy = true;
    try{
      const payload = { plate_image: snapDataURL() };
      const resp = await fetch("/gate/capture", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (data && data.gate_locked){
        showStatus(data.message || "Trạm đang bị khóa.", "alert alert-danger");
        // dừng loop để khỏi spam
        stopped = true;
        return;
      }

      // redirect
      if (data && data.action === "redirect" && data.redirect_url){
        stopped = true;
        window.location.href = data.redirect_url;
        return;
      }

      // nếu OCR fail thì thông báo nhẹ
      if (data && data.ok === false && data.message){
        showStatus(data.message, "alert alert-warning");
      }
    }catch(e){
      console.log(e);
    }finally{
      busy = false;
    }
  }

  async function main(){
    try{
      await startCamera();
      {% if gate_locked %}
        showStatus("Trạm đang bị khóa. Chỉ Admin mới mở khóa.", "alert alert-danger");
        stopped = true;
        return;
      {% endif %}
      showStatus("Đang quét biển số…", "alert alert-info");
      setInterval(loopCapture, 1200);
    }catch(e){
      showStatus("Không mở được camera. Vui lòng cấp quyền camera.", "alert alert-danger");
    }
  }

  main();

  // Admin unlock
  const btnUnlock = document.getElementById("btn-unlock");
  if (btnUnlock){
    btnUnlock.addEventListener("click", async ()=>{
      const resp = await fetch("/admin/gate/unlock", {method:"POST"});
      const data = await resp.json();
      if (data && data.ok){
        document.getElementById("unlock-msg").style.display="block";
      }else{
        alert((data && data.message) || "Không mở khóa được");
      }
    });
  }
</script>
{% endblock %}
