{% extends "base_gate.html" %}
{% block title %}Tráº¡m cá»•ng â€“ QuÃ©t biá»ƒn sá»‘{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    /* chá»‰nh nhá» thÃªm chÃºt Ä‘á»ƒ fit 1 mÃ n hÃ¬nh */
    .gate-status { font-size: 16px; }
    .btn-sm { white-space: nowrap; }
  </style>
{% endblock %}

{% block content %}
<div class="gate-wrap">

  <!-- âœ… Header má»›i: bá» badge "Gate" -->
  <div class="gate-hero">
    <div class="left">
      <span class="badge bg-dark">KIOSK</span>
      <div>
        <h1>TRáº M Cá»”NG â€“ QUÃ‰T BIá»‚N Sá»</h1>
        <p>Camera tá»± Ä‘á»™ng báº­t vÃ  tá»± nháº­n diá»‡n liÃªn tá»¥c</p>
      </div>
    </div>
    <div class="meta">
      <span class="badge bg-success">ONLINE</span>
      <button class="btn btn-light btn-sm" type="button" id="btn-reload">LÃ m má»›i</button>
    </div>
  </div>

  {% if gate_locked %}
  <div class="lock-box">
    <div class="fw-bold text-danger">âš  Tráº¡m Ä‘ang bá»‹ khÃ³a</div>
    <div>Do khÃ¡ch nháº­p sai mÃ£ vÃ© quÃ¡ 3 láº§n. Chá»‰ Admin má»›i má»Ÿ khÃ³a Ä‘Æ°á»£c.</div>

    {% if session.get("role") == "admin" %}
    <div class="mt-2 d-flex gap-2 flex-wrap">
      <button id="btn-unlock" class="btn btn-danger btn-sm">Má»Ÿ khÃ³a tráº¡m</button>
      <div id="unlock-msg" class="text-success fw-bold" style="display:none;">
        ÄÃ£ má»Ÿ khÃ³a! Reload trang Ä‘á»ƒ cháº¡y láº¡i.
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Status -->
  <div id="status" class="big-status alert alert-info"></div>

  <div class="gate-grid">

    <!-- Camera -->
    <div class="gcard">
      <div class="gcard-h">
        <span>ğŸ¥ Camera</span>
        <span class="text-muted" style="font-weight:700;font-size:12px;">Auto capture</span>
      </div>
      <div class="gcard-b" style="height:100%;min-height:0;">
        <div class="video-shell" style="height:100%;min-height:0;">
          <!-- giá»¯ nguyÃªn ID Ä‘á»ƒ khÃ´ng lá»—i JS -->
          <video id="cam" autoplay playsinline></video>
          <canvas id="cv" style="display:none;"></canvas>
        </div>
      </div>
    </div>

    <!-- Panel pháº£i (thÃ´ng tin gá»n) -->
    <div class="side-stack">

      <div class="gcard">
        <div class="gcard-h">
          <span>ğŸ“Œ Tráº¡ng thÃ¡i</span>
        </div>
        <div class="gcard-b">
          <div class="alert alert-secondary mb-0" style="border-radius:14px;">
            Há»‡ thá»‘ng sáº½ tá»± nháº­n diá»‡n má»—i ~1.2 giÃ¢y vÃ  tá»± chuyá»ƒn trang theo luá»“ng.
          </div>
        </div>
      </div>

      <div class="gcard">
        <div class="gcard-h">
          <span>ğŸ›  Äiá»u khiá»ƒn</span>
        </div>
        <div class="gcard-b">
          <button class="btn btn-primary w-100" id="btn-capture" type="button">
            Chá»¥p & Nháº­n diá»‡n ngay
          </button>
          <small class="text-muted d-block mt-2">
            * DÃ¹ng khi sá»‘ lÆ°á»£ng khÃ¡ch Ä‘Ã´ng.
          </small>
        </div>
      </div>

      {% if gate_locked %}
      <div class="gcard">
        <div class="gcard-h"><span>ğŸ”’ LÆ°u Ã½</span></div>
        <div class="gcard-b">
          <div class="alert alert-warning mb-0" style="border-radius:14px;">
            Tráº¡m Ä‘ang bá»‹ khÃ³a nÃªn há»‡ thá»‘ng sáº½ dá»«ng quÃ©t Ä‘á»ƒ trÃ¡nh spam request.
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<script>
  const video = document.getElementById("cam");
  const canvas = document.getElementById("cv");
  const statusBox = document.getElementById("status");

  let stream = null;
  let busy = false;
  let stopped = false;

  function showStatus(msg, cls="alert alert-info"){
    statusBox.className = "big-status show " + cls;
    statusBox.innerText = msg;
  }

  async function startCamera(){
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
  }

  function snapDataURL(){
    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);
    return canvas.toDataURL("image/png");
  }

  async function loopCapture(){
    if (stopped) return;
    if (busy) return;

    busy = true;
    try{
      const payload = { plate_image: snapDataURL() };
      const resp = await fetch("/gate/capture", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (data && data.gate_locked){
        showStatus(data.message || "Tráº¡m Ä‘ang bá»‹ khÃ³a.", "alert alert-danger");
        stopped = true;
        return;
      }

      if (data && data.action === "redirect" && data.redirect_url){
        stopped = true;
        window.location.href = data.redirect_url;
        return;
      }

      if (data && data.ok === false && data.message){
        showStatus(data.message, "alert alert-warning");
      }
    }catch(e){
      console.log(e);
    }finally{
      busy = false;
    }
  }

  async function main(){
    try{
      await startCamera();

      {% if gate_locked %}
        showStatus("Tráº¡m Ä‘ang bá»‹ khÃ³a. Chá»‰ Admin má»›i má»Ÿ khÃ³a.", "alert alert-danger");
        stopped = true;
        return;
      {% endif %}

      showStatus("Äang quÃ©t biá»ƒn sá»‘â€¦", "alert alert-info");
      setInterval(loopCapture, 1200);
    }catch(e){
      showStatus("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera. Vui lÃ²ng cáº¥p quyá»n camera.", "alert alert-danger");
    }
  }

  main();

  // Reload button
  document.getElementById("btn-reload")?.addEventListener("click", () => location.reload());

  // Manual capture
  document.getElementById("btn-capture")?.addEventListener("click", async () => {
    showStatus("Äang chá»¥p & nháº­n diá»‡nâ€¦", "alert alert-info");
    await loopCapture();
  });

  // Admin unlock
  const btnUnlock = document.getElementById("btn-unlock");
  if (btnUnlock){
    btnUnlock.addEventListener("click", async ()=>{
      const resp = await fetch("/admin/gate/unlock", {method:"POST"});
      const data = await resp.json();
      if (data && data.ok){
        document.getElementById("unlock-msg").style.display="block";
      }else{
        alert((data && data.message) || "KhÃ´ng má»Ÿ khÃ³a Ä‘Æ°á»£c");
      }
    });
  }
</script>
{% endblock %}
