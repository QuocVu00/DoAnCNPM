{% extends "base.html" %}
{% block title %}Tr·∫°m c·ªïng ‚Äì AI nh·∫≠n di·ªán bi·ªÉn s·ªë t·ª± ƒë·ªông{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .gate-page {
      max-width: 1200px;
      margin: 0 auto;
    }

    .gate-page h3 {
      margin-bottom: 0.75rem;
    }

    .gate-page p.text-muted {
      margin-bottom: 0.75rem;
    }

    .gate-card video {
      width: 100%;
      max-height: 380px;
      border-radius: 0.5rem;
      background: #000;
      object-fit: cover;
    }

    .gate-card canvas {
      display: none;
    }

    .gate-page .card-body {
      padding: 0.75rem 1rem;
    }

    .gate-page .card-header {
      padding: 0.5rem 1rem;
    }

    .gate-page .card-footer {
      padding: 0.5rem 1rem 0.75rem 1rem;
    }

    /* Overlay m√£ v√© to */
    #ticket-overlay {
      background: rgba(0, 0, 0, 0.7);
      z-index: 1050;
    }
  </style>
{% endblock %}

{% block content %}
<div class="gate-page py-4">
  <h2 class="text-center mb-3">
    üöó Tr·∫°m c·ªïng ‚Äì AI nh·∫≠n di·ªán bi·ªÉn s·ªë t·ª± ƒë·ªông
  </h2>
  <p class="text-center text-muted mb-4">
    Xe d·ª´ng t·∫°i v·∫°ch, h·ªá th·ªëng t·ª± ch·ª•p bi·ªÉn s·ªë, ph√¢n lo·∫°i <strong>c∆∞ d√¢n / kh√°ch ngo√†i</strong>,
    v√† ƒëi·ªÅu h∆∞·ªõng sang b∆∞·ªõc <strong>FaceID</strong> ho·∫∑c <strong>m√£ v√© 6 s·ªë</strong>.
  </p>

  <div class="row">
    <!-- C·ªôt tr√°i: Camera bi·ªÉn s·ªë -->
    <div class="col-lg-7 mb-3">
      <div class="card gate-card">
        <div class="card-header">
          <strong>Camera bi·ªÉn s·ªë</strong>
        </div>
        <div class="card-body">
          <video id="camera-video" autoplay playsinline></video>
          <canvas id="camera-canvas"></canvas>
        </div>
        <div class="card-footer d-flex justify-content-between gap-2">
          <button id="btn-start" class="btn btn-primary flex-grow-1">
            B·∫≠t camera &amp; AI t·ª± ƒë·ªông
          </button>
          <button id="btn-stop" class="btn btn-outline-danger flex-grow-1">
            D·ª´ng h·ªá th·ªëng
          </button>
        </div>
      </div>
    </div>

    <!-- C·ªôt ph·∫£i: Tr·∫°ng th√°i + M√£ v√© -->
    <div class="col-lg-5 mb-3">
      <!-- Tr·∫°ng th√°i x·ª≠ l√Ω -->
      <div class="card mb-3">
        <div class="card-header">
          <strong>Tr·∫°ng th√°i x·ª≠ l√Ω</strong>
        </div>
        <div class="card-body">
          <div id="gate-status-box" class="alert alert-info mb-2">
            <p id="gate-status-text" class="mb-0">
              H·ªá th·ªëng s·∫µn s√†ng. H√£y b·∫•m <strong>B·∫≠t camera &amp; AI t·ª± ƒë·ªông</strong>.
            </p>
          </div>
          <small class="text-muted d-block">
            Th√¥ng tin debug (developer) s·∫Ω hi·ªán trong console tr√¨nh duy·ªát v√† log server.
          </small>
        </div>
      </div>

      <!-- Nh·∫≠p bi·ªÉn s·ªë & m√£ v√© -->
      <div class="card">
        <div class="card-header">
          <strong>M√£ v√© / M√£ d·ª± ph√≤ng</strong>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Nh·∫≠p tay bi·ªÉn s·ªë (n·∫øu AI ƒë·ªçc kh√¥ng ƒë∆∞·ª£c)</label>
            <input
              type="text"
              id="manual-plate-input"
              class="form-control"
              placeholder="VD: 59A-123.45"
            >
          </div>

          <div class="mb-3">
            <label class="form-label">Vui l√≤ng nh·∫≠p m√£ v√© 6 s·ªë ƒë·ªÉ l·∫•y xe ra.</label>
            <div class="input-group">
              <input
                type="text"
                id="ticket-code-input"
                class="form-control"
                maxlength="6"
                placeholder="Nh·∫≠p m√£ v√© 6 s·ªë"
              >
              <button id="btn-confirm-ticket" class="btn btn-primary">
                X√°c nh·∫≠n m√£ v√©
              </button>
            </div>
            <small class="text-muted d-block mt-1">
              Sai qu√° <strong>3 l·∫ßn</strong> h·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã c·∫£nh b√°o cho nh√¢n vi√™n tr·ª±c.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay hi·ªÉn th·ªã m√£ v√© to 20 gi√¢y cho kh√°ch ngo√†i -->
<div
  id="ticket-overlay"
  class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center d-none"
>
  <div class="bg-white p-4 rounded shadow text-center" style="min-width: 320px;">
    <h3 class="mb-3">M√£ v√© c·ªßa b·∫°n</h3>
    <div id="ticket-overlay-text" class="fw-bold display-4 text-primary"></div>
    <p class="mt-3 mb-0">
      Vui l√≤ng ghi nh·ªõ / ch·ª•p l·∫°i m√£ n√†y ƒë·ªÉ xu·∫•t tr√¨nh khi l·∫•y xe ra.
    </p>
  </div>
</div>

<script>
  const video = document.getElementById("camera-video");
  const canvas = document.getElementById("camera-canvas");
  const btnStart = document.getElementById("btn-start");
  const btnStop = document.getElementById("btn-stop");
  const btnConfirmTicket = document.getElementById("btn-confirm-ticket");

  const statusBox = document.getElementById("gate-status-box");
  const statusText = document.getElementById("gate-status-text");
  const manualPlateInput = document.getElementById("manual-plate-input");
  const ticketInput = document.getElementById("ticket-code-input");

  const overlay = document.getElementById("ticket-overlay");
  const overlayText = document.getElementById("ticket-overlay-text");

  let mediaStream = null;
  let captureTimer = null;
  let isRunning = false;

  async function startCamera() {
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false,
      });
      video.srcObject = mediaStream;
    } catch (err) {
      console.error("Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c camera:", err);
      statusBox.className = "alert alert-danger";
      statusText.innerText = "Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c camera: " + err.message;
    }
  }

  function stopCamera() {
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    video.srcObject = null;
  }

  function startSystem() {
    if (isRunning) return;
    isRunning = true;

    statusBox.className = "alert alert-info";
    statusText.innerText = "H·ªá th·ªëng ƒëang ch·∫°y, AI s·∫Ω t·ª± ch·ª•p bi·ªÉn s·ªë li√™n t·ª•c...";

    startCamera();

    // 2 gi√¢y ch·ª•p & g·ª≠i 1 l·∫ßn
    captureTimer = setInterval(() => {
      captureAndSend(false);
    }, 2000);
  }

  function stopSystem() {
    isRunning = false;
    if (captureTimer) {
      clearInterval(captureTimer);
      captureTimer = null;
    }
    stopCamera();

    statusBox.className = "alert alert-secondary";
    statusText.innerText = "H·ªá th·ªëng ƒë√£ d·ª´ng. B·∫°n c√≥ th·ªÉ b·∫•m B·∫≠t camera ƒë·ªÉ ch·∫°y l·∫°i.";
  }

  function showOverlay(code) {
    if (!overlay || !overlayText) return;
    overlayText.innerText = code || "";
    overlay.classList.remove("d-none");

    // 20 gi√¢y sau t·ª± ·∫©n
    setTimeout(() => {
      overlay.classList.add("d-none");
    }, 20000);
  }

  function updateStatusUI(data) {
    console.log("gate_capture resp:", data);

    // M·∫∑c ƒë·ªãnh ·∫©n overlay
    if (overlay) overlay.classList.add("d-none");

    if (!data || data.ok === false) {
      statusBox.className = "alert alert-danger";
      statusText.innerText = (data && data.message) ?
        data.message : "L·ªói trong qu√° tr√¨nh x·ª≠ l√Ω. Vui l√≤ng th·ª≠ l·∫°i.";
      return;
    }

    // ====== XE C∆Ø D√ÇN V√ÄO B√ÉI ======
    if (data.user_type === "resident" && data.event_type === "resident_in") {
      statusBox.className = "alert alert-success";
      statusText.innerText = data.message || "Xe c∆∞ d√¢n ƒë√£ v√†o b√£i.";
      return;
    }

    // ====== XE C∆Ø D√ÇN RA B√ÉI -> CHUY·ªÇN SANG FACE ======
    if (data.user_type === "resident" && data.next_step === "face") {
      statusBox.className = "alert alert-info";
      statusText.innerText =
        data.message || "Chuy·ªÉn sang b∆∞·ªõc x√°c th·ª±c khu√¥n m·∫∑t...";

      const url =
        `/gate/face?resident_id=${data.resident_id}` +
        `&plate_text=${encodeURIComponent(data.plate_text || "")}` +
        `&mode=${data.mode || "OUT"}`;
      window.location.href = url;
      return;
    }

    // ====== KH√ÅCH V√ÉNG LAI V√ÄO B√ÉI (T·∫†O V√â) ======
    if (data.user_type === "guest" && data.event_type === "guest_in") {
      statusBox.className = "alert alert-success";
      const code = data.ticket_code || "";
      statusText.innerText =
        data.message ||
        `Xe kh√°ch ƒë√£ v√†o b√£i. M√£ v√© c·ªßa b·∫°n l√† ${code}.`;

      if (ticketInput && code) {
        ticketInput.value = code;
      }

      if (code) {
        showOverlay(code);
      }
      return;
    }

    // ====== KH√ÅCH V√ÉNG LAI RA B√ÉI (ƒê√É NH·∫¨P ƒê√öNG M√É V√â) ======
    if (data.user_type === "guest" && data.event_type === "guest_out") {
      statusBox.className = "alert alert-success";
      statusText.innerText = data.message || "Xe kh√°ch ƒë√£ ra b√£i.";
      return;
    }

    // ====== Tr∆∞·ªùng h·ª£p y√™u c·∫ßu nh·∫≠p ho·∫∑c nh·∫≠p sai m√£ v√© ======
    if (data.need_ticket_code) {
      statusBox.className = "alert alert-warning";
      statusText.innerText =
        data.message ||
        "Vui l√≤ng nh·∫≠p m√£ v√© 6 s·ªë ƒë∆∞·ª£c c·∫•p khi g·ª≠i xe.";
      if (data.plate_text && !manualPlateInput.value) {
        manualPlateInput.value = data.plate_text;
      }
      return;
    }

    // M·∫∑c ƒë·ªãnh
    statusBox.className = "alert alert-info";
    statusText.innerText = data.message || "ƒê√£ x·ª≠ l√Ω xong.";
  }

  async function captureAndSend(forceOnce) {
    try {
      if (!video || video.readyState < 2) {
        // Video ch∆∞a s·∫µn s√†ng
        return;
      }

      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      const dataUrl = canvas.toDataURL("image/png");

      const payload = {
        mode: "AUTO",
        plate_image: dataUrl,
        face_image: null,
        scene_image: null,
        guest_ticket_code: (ticketInput.value || "").trim() || null,
        plate_text_manual: (manualPlateInput.value || "").trim() || null,
      };

      const resp = await fetch("/gate/capture", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await resp.json();
      updateStatusUI(data);

      // N·∫øu l·∫ßn n√†y ch·ªâ g·ª≠i ƒë·ªÉ x√°c nh·∫≠n m√£ v√© (forceOnce) ‚Üí kh√¥ng c·∫ßn l·∫∑p
      if (forceOnce) {
        console.log("Sent one-time capture for ticket confirm.");
      }
    } catch (err) {
      console.error("L·ªói khi ch·ª•p & g·ª≠i:", err);
      statusBox.className = "alert alert-danger";
      statusText.innerText = "L·ªói khi ch·ª•p & g·ª≠i: " + err.message;
    }
  }

  // ===== G·∫Øn event =====
  btnStart.addEventListener("click", (e) => {
    e.preventDefault();
    startSystem();
  });

  btnStop.addEventListener("click", (e) => {
    e.preventDefault();
    stopSystem();
  });

  // Khi ·∫•n "X√°c nh·∫≠n m√£ v√©" => ch·ª•p 1 frame & g·ª≠i k√®m m√£ v√© hi·ªán t·∫°i
  btnConfirmTicket.addEventListener("click", (e) => {
    e.preventDefault();
    // g·ª≠i 1 l·∫ßn, kh√¥ng c·∫ßn b·∫≠t auto
    if (!mediaStream) {
      startCamera().then(() => captureAndSend(true));
    } else {
      captureAndSend(true);
    }
  });
</script>
{% endblock %}
