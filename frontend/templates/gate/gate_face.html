{% extends "base.html" %}
{% block title %}Tr·∫°m FaceID c∆∞ d√¢n{% endblock %}

{% block head %}
{{ super() }}
<style>
  .face-video {
    width: 100%;
    max-height: 380px;
    border-radius: 0.5rem;
    background: #000;
    object-fit: cover;
  }
  .big-message {
    font-size: 1.4rem;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- metadata cho JS -->
  <div id="faceMeta"
       data-resident-id="{{ resident_id or '' }}"
       data-plate-text="{{ plate_text or '' }}"
       data-mode="{{ mode or 'AUTO' }}">
  </div>

  <h3 class="mb-3 text-center fw-bold">
    üòÉ Tr·∫°m FaceID c∆∞ d√¢n
  </h3>
  <p class="text-muted text-center small mb-4">
    Xe ƒë√£ ƒë∆∞·ª£c nh·∫≠n di·ªán l√† <strong>c∆∞ d√¢n</strong> (bi·ªÉn s·ªë:
    <strong>{{ plate_text or 'kh√¥ng r√µ' }}</strong>).
    M·ªùi t√†i x·∫ø ƒë∆∞a khu√¥n m·∫∑t v√†o ƒë√∫ng v·ªã tr√≠ camera ƒë·ªÉ x√°c th·ª±c.
  </p>

  <div class="row g-3">
    <!-- Camera -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          Camera khu√¥n m·∫∑t
        </div>
        <div class="card-body text-center">
          <video id="videoFace" autoplay playsinline class="face-video"></video>
          <canvas id="canvasFace" class="d-none"></canvas>
        </div>
      </div>
    </div>

    <!-- Th√¥ng tin + ƒëi·ªÅu khi·ªÉn -->
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          Th√¥ng tin l∆∞·ª£t xe
        </div>
        <div class="card-body">
          <p class="mb-1">
            <strong>Resident ID:</strong> {{ resident_id or 'N/A' }}<br>
            <strong>Bi·ªÉn s·ªë:</strong> {{ plate_text or 'N/A' }}<br>
            <strong>Ch·∫ø ƒë·ªô:</strong>
            {% if mode == 'OUT' %}
              Ra b√£i (Check-out)
            {% elif mode == 'IN' %}
              V√†o b√£i (Check-in)
            {% else %}
              T·ª± ƒë·ªông (AUTO)
            {% endif %}
          </p>
          <hr>

          <div class="mb-2">
            <label class="form-label mb-1">K·∫øt qu·∫£ nh·∫≠n di·ªán khu√¥n m·∫∑t</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="faceResult"
                     id="faceOk" value="ok" checked>
              <label class="form-check-label" for="faceOk">
                H·ªá th·ªëng nh·∫≠n di·ªán ƒë√∫ng (cho xe qua)
              </label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="faceResult"
                     id="faceFail" value="fail">
              <label class="form-check-label" for="faceFail">
                Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c (d√πng m√£ 6 s·ªë)
              </label>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label" for="backupCode">
              M√£ d·ª± ph√≤ng c∆∞ d√¢n (6 s·ªë ‚Äì d√πng khi FaceID l·ªói)
            </label>
            <input type="text" id="backupCode" class="form-control"
                   maxlength="6"
                   placeholder="Nh·∫≠p m√£ 6 s·ªë c∆∞ d√¢n...">
            <small class="text-muted">
              N·∫øu ch·ª•p sai m·∫∑t nhi·ªÅu l·∫ßn, b·∫£o v·ªá y√™u c·∫ßu c∆∞ d√¢n nh·∫≠p ƒë√∫ng m√£ n√†y ƒë·ªÉ cho xe ra/v√†o.
            </small>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-secondary flex-grow-1" type="button" id="btnStartFace">
              B·∫≠t camera
            </button>
            <button class="btn btn-primary flex-grow-1" type="button" id="btnCaptureFace">
              Ch·ª•p &amp; x√°c th·ª±c
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Tr·∫°ng th√°i</div>
        <div class="card-body">
          <div id="faceStatus" class="alert alert-info big-message mb-2">
            Ch∆∞a b·∫≠t camera.
          </div>
          <div id="faceDebug" class="small text-muted"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function () {
  const metaDiv   = document.getElementById("faceMeta");
  const residentId = metaDiv.dataset.residentId || null;
  const plateText  = metaDiv.dataset.plateText || null;
  const mode       = metaDiv.dataset.mode || "AUTO";

  const video  = document.getElementById("videoFace");
  const canvas = document.getElementById("canvasFace");
  const btnStart   = document.getElementById("btnStartFace");
  const btnCapture = document.getElementById("btnCaptureFace");
  const statusBox  = document.getElementById("faceStatus");
  const debugBox   = document.getElementById("faceDebug");
  const backupCodeEl = document.getElementById("backupCode");

  let stream = null;
  let attemptCount = 0;
  const MAX_ATTEMPTS = 3;

  async function startCamera() {
    if (stream) return;
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
      });
      video.srcObject = stream;

      statusBox.className = "alert alert-success big-message";
      statusBox.textContent = "Camera ƒë√£ b·∫≠t ‚Äì m·ªùi c∆∞ d√¢n ƒë∆∞a khu√¥n m·∫∑t v√†o khung h√¨nh.";
    } catch (err) {
      console.error(err);
      statusBox.className = "alert alert-danger big-message";
      statusBox.textContent = "Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: " + err.message;
    }
  }

  function captureFrame() {
    if (!video || video.readyState < 2) return null;

    const width  = video.videoWidth  || 640;
    const height = video.videoHeight || 480;

    canvas.width  = width;
    canvas.height = height;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, width, height);
    return canvas.toDataURL("image/png");
  }

  async function captureAndSendFace() {
    if (!stream) {
      statusBox.className = "alert alert-warning big-message";
      statusBox.textContent = "H√£y b·∫≠t camera tr∆∞·ªõc khi ch·ª•p.";
      return;
    }

    const dataUrl = captureFrame();
    if (!dataUrl) {
      statusBox.className = "alert alert-warning big-message";
      statusBox.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c khung h√¨nh, th·ª≠ l·∫°i.";
      return;
    }

    const faceResult = document.querySelector('input[name="faceResult"]:checked').value;
    const faceOk = (faceResult === "ok");
    const backupCode = (backupCodeEl.value || "").trim() || null;

    statusBox.className = "alert alert-info big-message";
    statusBox.textContent = "ƒêang g·ª≠i ·∫£nh khu√¥n m·∫∑t l√™n server...";

    try {
      const resp = await fetch("/gate/face/capture", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          resident_id: residentId,
          plate_text: plateText,
          mode: mode,
          face_image: dataUrl,
          scene_image: null,
          face_ok: faceOk,
          backup_code: backupCode
        })
      });

      const data = await resp.json();
      debugBox.textContent = JSON.stringify(data, null, 2);

      if (data.ok) {
        // X√°c th·ª±c th√†nh c√¥ng -> cho xe qua & t·∫°m bi·ªát
        statusBox.className = "alert alert-success big-message";
        statusBox.textContent =
          data.message ||
          "C∆∞ d√¢n ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c, barie m·ªü. Xin ch√∫c qu√Ω kh√°ch th∆∞·ª£ng l·ªô b√¨nh an!";

        // C√≥ th·ªÉ d·ª´ng camera cho ƒë·∫πp
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
      } else {
        // C·∫ßn nh·∫≠p / nh·∫≠p sai m√£ 6 s·ªë
        attemptCount += 1;

        let msg = data.message || "Kh√¥ng x√°c th·ª±c ƒë∆∞·ª£c khu√¥n m·∫∑t.";
        if (data.need_backup_code) {
          msg += " Vui l√≤ng nh·∫≠p ƒë√∫ng m√£ 6 s·ªë c∆∞ d√¢n.";
        }

        if (attemptCount >= MAX_ATTEMPTS) {
          msg = "Sai qu√° 3 l·∫ßn trong th·ªùi gian ng·∫Øn ‚Äì h·ªá th·ªëng ƒë√£ c·∫£nh b√°o. "
              + "Vui l√≤ng nh·∫≠p ƒë√∫ng m√£ d·ª± ph√≤ng ho·∫∑c li√™n h·ªá b·∫£o v·ªá.";
        }

        statusBox.className = "alert alert-warning big-message";
        statusBox.textContent = msg;
      }
    } catch (err) {
      console.error(err);
      statusBox.className = "alert alert-danger big-message";
      statusBox.textContent = "L·ªói khi g·ª≠i d·ªØ li·ªáu: " + err.message;
    }
  }

  btnStart.addEventListener("click", startCamera);
  btnCapture.addEventListener("click", captureAndSendFace);
})();
</script>
{% endblock %}
