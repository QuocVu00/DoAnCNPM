{% extends "base_gate.html" %}
{% block title %}Tr·∫°m FaceID c∆∞ d√¢n{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .face-status{ font-size:16px; }
    .btn-sm{ white-space:nowrap; }
  </style>
{% endblock %}

{% block content %}
<div class="gate-wrap">

  <!-- Header gi·ªëng gate_plate -->
  <div class="gate-hero">
    <div class="left">
      <span class="badge bg-dark">FACE ID</span>
      <div>
        <h1>X√ÅC TH·ª∞C KHU√îN M·∫∂T C∆Ø D√ÇN</h1>
        <p>H·ªá th·ªëng t·ª± ch·ª•p & ƒë·ªëi chi·∫øu khi xe ra</p>
      </div>
    </div>
    <div class="meta">
      <span class="badge bg-warning text-dark">Plate: {{ plate_text }}</span>
      <button class="btn btn-light btn-sm" type="button" id="btn-reload">L√†m m·ªõi</button>
    </div>
  </div>

  <!-- Status -->
  <div id="status" class="big-status alert alert-info face-status">
    ƒêang m·ªü camera‚Ä¶
  </div>

  <div class="gate-grid">

    <!-- Camera -->
    <div class="gcard">
      <div class="gcard-h">
        <span>üì∑ Camera FaceID</span>
        <span class="text-muted" style="font-weight:700;font-size:12px;">Auto verify</span>
      </div>
      <div class="gcard-b" style="height:100%;min-height:0;">
        <div class="video-shell" style="height:100%;min-height:0;">
          <video id="cam" autoplay playsinline></video>
          <canvas id="cv" style="display:none;"></canvas>
        </div>
      </div>
    </div>

    <!-- Panel ph·∫£i -->
    <div class="side-stack">

      <div class="gcard">
        <div class="gcard-h">
          <span>üìå Th√¥ng tin</span>
        </div>
        <div class="gcard-b">
          <div class="kv">
            <div class="k">C∆∞ d√¢n</div>
            <div class="v">{{ resident_id }}</div>
          </div>
          <div class="kv mt-2">
            <div class="k">Bi·ªÉn s·ªë</div>
            <div class="v">{{ plate_text }}</div>
          </div>
          <div class="kv mt-2">
            <div class="k">Ch·∫ø ƒë·ªô</div>
            <div class="v">{{ mode }}</div>
          </div>
        </div>
      </div>

      <!-- Backup code -->
      <div id="codeBox" class="gcard" style="display:none;">
        <div class="gcard-h">
          <span>üîë M√£ d·ª± ph√≤ng (6 s·ªë)</span>
        </div>
        <div class="gcard-b">
          <input
            id="backup"
            class="form-control compact-input"
            inputmode="numeric"
            maxlength="6"
            placeholder="Nh·∫≠p 6 s·ªë"
          />
          <button id="btnSend" class="btn btn-primary w-100 mt-2">
            G·ª≠i x√°c th·ª±c
          </button>
          <small class="text-muted d-block mt-2">
            * D√πng khi FaceID kh√¥ng kh·ªõp
          </small>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const video = document.getElementById("cam");
  const canvas = document.getElementById("cv");
  const statusBox = document.getElementById("status");
  const codeBox = document.getElementById("codeBox");
  const backupInput = document.getElementById("backup");
  const btnSend = document.getElementById("btnSend");

  const residentId = "{{ resident_id }}";
  const plateText = "{{ plate_text }}";
  const mode = "{{ mode }}";

  let stream=null, busy=false, stopped=false;

  function setStatus(msg, cls="alert alert-info"){
    statusBox.className = "big-status show " + cls;
    statusBox.innerText = msg;
  }

  async function startCamera(){
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"user" },
      audio:false
    });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
  }

  function snapDataURL(){
    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0,w,h);
    return canvas.toDataURL("image/png");
  }

  async function sendFace(backupCode=null){
    if (busy || stopped) return;
    busy=true;
    try{
      const payload = {
        resident_id: residentId,
        plate_text: plateText,
        mode: mode,
        face_image: snapDataURL(),
        backup_code: backupCode
      };
      const resp = await fetch("/gate/face/capture", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (data && data.ok && data.redirect_url){
        stopped=true;
        window.location.href = data.redirect_url;
        return;
      }

      if (data && data.need_backup_code){
        setStatus(data.message || "Kh√¥ng x√°c th·ª±c ƒë∆∞·ª£c. Nh·∫≠p m√£ 6 s·ªë.", "alert alert-warning");
        codeBox.style.display="block";
        setTimeout(()=>backupInput.focus(), 50);
        return;
      }

      if (data && data.ok === false && data.message){
        setStatus(data.message, "alert alert-warning");
      }
    }catch(e){
      console.log(e);
      setStatus("L·ªói k·∫øt n·ªëi. Th·ª≠ l·∫°i.", "alert alert-danger");
    }finally{
      busy=false;
    }
  }

  async function main(){
    try{
      await startCamera();
      setStatus("ƒêang x√°c th·ª±c khu√¥n m·∫∑t‚Ä¶", "alert alert-info");
      setInterval(()=>sendFace(null), 1200);
    }catch(e){
      setStatus("Kh√¥ng m·ªü ƒë∆∞·ª£c camera. Vui l√≤ng c·∫•p quy·ªÅn.", "alert alert-danger");
    }
  }

  // Reload
  document.getElementById("btn-reload")?.addEventListener("click", ()=>location.reload());

  // Backup submit
  btnSend?.addEventListener("click", ()=>{
    const code = (backupInput.value||"").trim();
    if (code.length !== 6) return;
    sendFace(code);
  });

  backupInput?.addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){
      e.preventDefault();
      btnSend.click();
    }
  });

  main();
</script>
{% endblock %}
