{% extends "base.html" %}
{% block title %}Trạm FaceID cư dân{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .wrap{max-width:1100px;margin:0 auto}
    .hero{
      background: linear-gradient(135deg,#111827,#2563eb);
      color:#fff;border-radius:16px;padding:18px 20px;
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .hero h3{margin:0;font-weight:800}
    .hero p{margin:0;opacity:.9}
    .card video{width:100%;max-height:420px;border-radius:14px;background:#000;object-fit:cover}
    .status{border-radius:14px;padding:14px 16px;font-weight:800;font-size:18px}
    .code-box{display:none}
    .code-box.show{display:block}
  </style>
{% endblock %}

{% block content %}
<div class="container py-4 wrap">
  <div class="hero mb-3">
    <div>
      <h3>FACEID CƯ DÂN – XÁC THỰC KHI XE RA</h3>
      <p>Hệ thống tự chụp & đối chiếu. Nếu sai sẽ yêu cầu mã 6 số.</p>
    </div>
    <div class="text-end">
      <div class="badge bg-warning text-dark">Plate: {{ plate_text }}</div>
    </div>
  </div>

  <div id="status" class="status alert alert-info">Đang mở camera…</div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <video id="cam" autoplay playsinline></video>
      <canvas id="cv" style="display:none;"></canvas>
    </div>
  </div>

  <div id="codeBox" class="code-box">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="fw-bold mb-2">Nhập mã 6 số (backup code)</div>
        <div class="d-flex gap-2">
          <input id="backup" class="form-control" placeholder="Nhập 6 số..." inputmode="numeric" maxlength="6">
          <button id="btnSend" class="btn btn-primary">Gửi</button>
        </div>
        <div class="text-muted mt-2">Nhấn Enter để gửi nhanh.</div>
      </div>
    </div>
  </div>
</div>

<script>
  const video = document.getElementById("cam");
  const canvas = document.getElementById("cv");
  const statusBox = document.getElementById("status");
  const codeBox = document.getElementById("codeBox");
  const backupInput = document.getElementById("backup");
  const btnSend = document.getElementById("btnSend");

  const residentId = "{{ resident_id }}";
  const plateText = "{{ plate_text }}";
  const mode = "{{ mode }}";

  let stream=null, busy=false, stopped=false;

  function setStatus(msg, cls="alert alert-info"){
    statusBox.className="status " + cls;
    statusBox.innerText=msg;
  }

  async function startCamera(){
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
  }

  function snapDataURL(){
    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0,w,h);
    return canvas.toDataURL("image/png");
  }

  async function sendFace(backupCode=null){
    if (busy || stopped) return;
    busy=true;
    try{
      const payload = {
        resident_id: residentId,
        plate_text: plateText,
        mode: mode,
        face_image: snapDataURL(),
        backup_code: backupCode
      };
      const resp = await fetch("/gate/face/capture", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (data && data.ok && data.redirect_url){
        stopped=true;
        window.location.href = data.redirect_url;
        return;
      }

      if (data && data.need_backup_code){
        setStatus(data.message || "Không xác thực được. Nhập mã 6 số.", "alert alert-warning");
        codeBox.classList.add("show");
        setTimeout(()=>backupInput.focus(), 50);
        return;
      }

      if (data && data.ok === false && data.message){
        setStatus(data.message, "alert alert-warning");
      }
    }catch(e){
      console.log(e);
      setStatus("Lỗi kết nối. Thử lại.", "alert alert-danger");
    }finally{
      busy=false;
    }
  }

  async function main(){
    try{
      await startCamera();
      setStatus("Đang xác thực khuôn mặt…", "alert alert-info");
      // auto loop: tự chụp liên tục
      setInterval(()=>sendFace(null), 1200);
    }catch(e){
      setStatus("Không mở được camera. Vui lòng cấp quyền.", "alert alert-danger");
    }
  }

  btnSend.addEventListener("click", ()=>{
    const code = (backupInput.value||"").trim();
    if (!code) return;
    sendFace(code);
  });
  backupInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter"){
      e.preventDefault();
      btnSend.click();
    }
  });

  main();
</script>
{% endblock %}
