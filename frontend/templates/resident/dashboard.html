{% extends "base.html" %}
{% block title %}Resident Dashboard{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .resident-main.with-chat {
      padding-right: 380px;
      transition: padding-right 0.2s ease-in-out;
    }

    #residentChatPanel {
      position: fixed;
      top: 56px;
      right: 0;
      width: 360px;
      height: calc(100vh - 56px);
      background-color: #fdfdfd;
      box-shadow: -4px 0 12px rgba(15, 23, 42, 0.18);
      border-left: 1px solid #e5e7eb;
      display: none;
      z-index: 1040;
    }

    #residentChatPanel.show {
      display: flex;
      flex-direction: column;
    }

    /* Avatar cư dân: ưu tiên ảnh, nếu không có thì hiện chữ cái */
    .resident-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0d6efd, #22c55e);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 22px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      overflow: hidden;
    }

    .resident-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .resident-subtitle {
      color: #6b7280;
      font-size: 0.9rem;
    }

    .card {
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.04);
    }

    .card-header {
      font-weight: 600;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
  </style>
{% endblock %}

{% block content %}

<div class="resident-main">

  <!-- Avatar + lời chào theo thời gian -->
  <div class="d-flex align-items-center gap-3 mb-3">
    <div class="resident-avatar">
      {% if avatar_url %}
        <img src="{{ avatar_url }}" alt="Ảnh cư dân">
      {% else %}
        {{ resident.full_name[:1]|upper }}
      {% endif %}
    </div>
    <div>
      <h4 class="mb-1">
        Xin chào {{ greeting_time }} cư dân {{ resident.full_name }}
      </h4>
      <div class="resident-subtitle">
        Căn hộ: Tầng {{ resident.floor }}, phòng {{ resident.room }}
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <!-- Thông tin chung -->
    <div class="col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-header">Thông tin chung</div>
        <div class="card-body">
          <p class="mb-2">
            <b>Căn hộ:</b>
            <span class="ms-1">Tầng {{ resident.floor }}, phòng {{ resident.room }}</span>
          </p>
          <p class="mb-2">
            <b>Biển số xe:</b>
            <span class="ms-1">
              {% if primary_plate %}
                {{ primary_plate }}
              {% else %}
                <span class="text-muted">Chưa cập nhật</span>
              {% endif %}
            </span>
          </p>
          <p class="mb-2">
            <b>Mã dự phòng:</b>
            <span class="ms-1">
              {% if backup_code %}
                {{ backup_code }}
              {% else %}
                <span class="text-muted">Chưa được cấp</span>
              {% endif %}
            </span>
          </p>
          <p class="mb-0">
            <b>Trạng thái xe:</b>
            <span class="ms-1">
              {% if vehicles and vehicles[0].is_in_parking %}
                <span class="text-success">Đang ở bãi</span>
              {% else %}
                <span class="text-muted">Không ở bãi</span>
              {% endif %}
            </span>
          </p>
        </div>
      </div>
    </div>

    <!-- Lịch sử ra/vào -->
    <div class="col-md-6 mb-3">
      <div class="card h-100">
        <div class="card-header">Lịch sử ra/vào gần đây</div>
        <div class="card-body p-0">
          <table class="table mb-0 table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 40%;">Thời gian</th>
                <th style="width: 30%;">Loại</th>
                <th style="width: 30%;">Biển số</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
              <tr>
                <td>{{ log.event_time }}</td>
                <td>
                  {% if log.event_type == 'resident_in' %}
                    Vào (cư dân)
                  {% elif log.event_type == 'resident_out' %}
                    Ra (cư dân)
                  {% elif log.event_type == 'guest_in' %}
                    Vào (khách)
                  {% elif log.event_type == 'guest_out' %}
                    Ra (khách)
                  {% else %}
                    {{ log.event_type }}
                  {% endif %}
                </td>
                <td>{{ log.plate }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted py-3">
                  Chưa có dữ liệu
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

{# ====== PANEL CHAT CỐ ĐỊNH BÊN PHẢI ====== #}
<div id="residentChatPanel">
  <div class="d-flex align-items-center justify-content-between border-bottom px-3 py-2">
    <h6 class="mb-0">Trò chuyện với admin</h6>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      id="closeResidentChat"
    ></button>
  </div>

  <div class="d-flex flex-column flex-grow-1 px-3 py-2">
    <!-- Lịch sử chat -->
    <div
      class="border rounded mb-3 p-2 flex-grow-1"
      style="overflow-y: auto; background-color: #f8fafc;"
    >
      {% if messages %}
        {% for m in messages %}
          {% if m.sender == 'resident' %}
            <div class="d-flex justify-content-end mb-2">
              <div class="bg-primary text-white rounded-3 px-3 py-2">
                <div class="small">{{ m.content }}</div>
                <div class="small text-light text-end" style="font-size: 0.75rem;">
                  Bạn • {{ m.time }}
                </div>
              </div>
            </div>
          {% else %}
            <div class="d-flex justify-content-start mb-2">
              <div class="bg-white border rounded-3 px-3 py-2">
                <div class="small">{{ m.content }}</div>
                <div class="small text-muted" style="font-size: 0.75rem;">
                  Admin • {{ m.time }}
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="text-muted text-center small py-3">
          Chưa có tin nhắn nào. Hãy gửi tin nhắn đầu tiên cho admin.
        </div>
      {% endif %}
    </div>

    <!-- Form gửi tin -->
    <form method="post" action="{{ url_for('resident_chat_send') }}">
      <div class="mb-2">
        <label class="form-label">Nội dung tin nhắn</label>
        <textarea
          name="message"
          rows="2"
          class="form-control"
          placeholder="Nhập tin nhắn gửi cho admin..."
          required
        ></textarea>
      </div>
      <button class="btn btn-primary w-100" type="submit">Gửi</button>
    </form>
  </div>
</div>
{% endblock %}
